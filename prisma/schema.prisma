generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // DIRECT_URL is optional - Prisma will use DATABASE_URL if DIRECT_URL is not set
  // Uncomment below if you need direct connection for migrations
  // directUrl = env("DIRECT_URL")
}

model api_keys {
  id          String    @id
  name        String
  key         String    @unique
  permissions Json
  lastUsed    DateTime?
  expiresAt   DateTime?
  status      Status    @default(ACTIVE)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  tenantId    String
  userId      String
  tenants     tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users       users     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model api_usage {
  id             String         @id
  tenantId       String
  endpoint       String
  method         String
  statusCode     Int
  responseTime   Int
  tokensUsed     Int?
  model          String?
  userId         String?
  botId          String?
  conversationId String?
  metadata       Json?
  timestamp      DateTime       @default(now())
  conversations  conversations? @relation(fields: [conversationId], references: [id])
  tenants        tenants        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model billing_history {
  id                    String          @id
  tenantId              String
  invoiceNumber         String          @unique
  amount                Float
  currency              String          @default("USD")
  stripeInvoiceId       String?
  stripePaymentIntentId String?
  status                InvoiceStatus   @default(PENDING)
  billingPeriodStart    DateTime
  billingPeriodEnd      DateTime
  plan                  Plan
  planChange            PlanChangeType?
  description           String?
  metadata              Json?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime
  tenants               tenants         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model bots {
  id              String            @id
  name            String
  description     String?
  avatar          String?
  personality     String?
  model           String            @default("gpt-3.5-turbo")
  temperature     Float             @default(0.7)
  maxTokens       Int               @default(1000)
  status          Status            @default(ACTIVE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  tenantId        String
  config          Json?
  tenants         tenants           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversations   conversations[]
  knowledge_bases knowledge_bases[]
  widgets         widgets[]
}

model conversations {
  id            String             @id
  status        ConversationStatus @default(ACTIVE)
  tenantId      String
  botId         String
  userId        String
  closedAt      DateTime?
  lastMessageAt DateTime
  messageCount  Int                @default(0)
  metadata      Json?
  startedAt     DateTime           @default(now())
  title         String?
  totalCost     Float              @default(0.0)
  totalTokens   Int                @default(0)
  api_usage     api_usage[]
  bots          bots               @relation(fields: [botId], references: [id], onDelete: Cascade)
  tenants       tenants            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users         users              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      messages[]
}

model documents {
  id              String          @id
  title           String
  content         String
  type            DocumentType
  url             String?
  status          Status          @default(ACTIVE)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  knowledgeBaseId String
  embeddings      Json?
  knowledge_bases knowledge_bases @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
}

model faqs {
  id              String          @id
  question        String
  answer          String
  category        String?
  status          Status          @default(ACTIVE)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  knowledgeBaseId String
  knowledge_bases knowledge_bases @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
}

model knowledge_bases {
  id          String      @id
  name        String
  description String?
  status      Status      @default(ACTIVE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  tenantId    String
  botId       String
  documents   documents[]
  faqs        faqs[]
  bots        bots        @relation(fields: [botId], references: [id], onDelete: Cascade)
  tenants     tenants     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model messages {
  id             String        @id
  content        String
  role           MessageRole
  metadata       Json?
  conversationId String
  cost           Float         @default(0.0)
  createdAt      DateTime      @default(now())
  model          String?
  responseTime   Int?
  tokens         Int           @default(0)
  conversations  conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

model notification_preferences {
  id              String                @id
  userId          String
  category        NotificationCategory
  inAppEnabled    Boolean               @default(true)
  emailEnabled    Boolean               @default(false)
  smsEnabled      Boolean               @default(false)
  frequency       NotificationFrequency @default(REALTIME)
  quietHoursStart String?
  quietHoursEnd   String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime
  users           users                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
}

model notifications {
  id        String               @id
  userId    String
  tenantId  String
  type      NotificationType
  title     String
  message   String
  category  NotificationCategory
  priority  NotificationPriority @default(MEDIUM)
  actionUrl String?
  metadata  Json?
  isRead    Boolean              @default(false)
  createdAt DateTime             @default(now())
  readAt    DateTime?
  tenants   tenants              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users     users                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, isRead])
}

model subscriptions {
  id                   String             @id
  tenantId             String             @unique
  plan                 Plan               @default(FREE)
  previousPlan         Plan?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  monthlyUsage         Json               @default("{}")
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  trialEndsAt          DateTime?
  isTrialExpired       Boolean            @default(false)
  tenants              tenants            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model tenants {
  id              String            @id
  name            String
  subdomain       String            @unique
  customDomain    String?
  plan            Plan              @default(FREE)
  status          Status            @default(ACTIVE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  api_keys        api_keys[]
  api_usage       api_usage[]
  billing_history billing_history[]
  bots            bots[]
  conversations   conversations[]
  knowledge_bases knowledge_bases[]
  notifications   notifications[]
  subscriptions   subscriptions?
  users           users[]
  widgets         widgets[]
}

model users {
  id                       String                     @id
  email                    String
  name                     String?
  password                 String?
  role                     UserRole                   @default(USER)
  status                   Status                     @default(ACTIVE)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  tenantId                 String
  api_keys                 api_keys[]
  conversations            conversations[]
  notification_preferences notification_preferences[]
  notifications            notifications[]
  tenants                  tenants                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([email, tenantId])
}

model widgets {
  id        String     @id
  name      String
  type      WidgetType
  config    Json
  status    Status     @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime
  tenantId  String
  botId     String
  bots      bots       @relation(fields: [botId], references: [id], onDelete: Cascade)
  tenants   tenants    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum DocumentType {
  PDF
  DOCX
  TXT
  HTML
  MARKDOWN
  JSON
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  VOID
  REFUNDED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum NotificationCategory {
  bot_activity
  system
  metrics
  team
  billing
  security
  kb
  widget
}

enum NotificationFrequency {
  REALTIME
  HOURLY_DIGEST
  DAILY_DIGEST
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NotificationType {
  BOT_ACTIVITY
  SYSTEM
  METRICS
  TEAM
  BILLING
  SECURITY
  KB
  WIDGET
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
  WHITE_LABEL
}

enum PlanChangeType {
  UPGRADE
  DOWNGRADE
  CANCELLATION
  REACTIVATION
}

enum Status {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  UNPAID
}

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  USER
  BOT_OPERATOR
}

enum WidgetType {
  CHAT_WIDGET
  POPUP
  EMBEDDED
  FLOATING
}
